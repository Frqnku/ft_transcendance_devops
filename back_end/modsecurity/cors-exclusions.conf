# Exclusions CORS pour ModSecurity
# À placer dans /etc/nginx/modsec/cors-exclusions.conf

# Permettre les requêtes OPTIONS (preflight CORS) sur tous les endpoints
SecRule REQUEST_METHOD "@streq OPTIONS" \
    "id:1001,\
    phase:1,\
    pass,\
    nolog,\
    msg:'Allow CORS preflight OPTIONS requests',\
    ctl:ruleEngine=Off"

# Ou plus spécifique - désactiver certaines règles pour les endpoints API
SecRule REQUEST_URI "@beginsWith /auth/" \
    "id:1002,\
    phase:1,\
    pass,\
    nolog,\
    msg:'Disable rules for auth endpoints',\
    ctl:ruleRemoveById=911100,\
    ctl:ruleRemoveById=920420,\
    ctl:ruleRemoveById=920440"

SecRule REQUEST_URI "@beginsWith /2fa/" \
    "id:1003,\
    phase:1,\
    pass,\
    nolog,\
    msg:'Disable rules for 2fa endpoints',\
    ctl:ruleRemoveById=911100,\
    ctl:ruleRemoveById=920420,\
    ctl:ruleRemoveById=920440"

# Permettre les headers CORS spécifiques
SecRule REQUEST_HEADERS:Origin "@rx .*" \
    "id:1004,\
    phase:1,\
    pass,\
    nolog,\
    msg:'Allow Origin header',\
    ctl:ruleRemoveById=920440"

# Permettre Content-Type application/json pour les API
SecRule REQUEST_HEADERS:Content-Type "@rx ^application/json" \
    "id:1005,\
    phase:1,\
    pass,\
    nolog,\
    msg:'Allow JSON content type',\
    ctl:ruleRemoveById=920420"